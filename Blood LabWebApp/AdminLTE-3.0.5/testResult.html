<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Alpha Lab Admin Panel</title>
  <!-- Tell the browser to be responsive to screen width -->
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="plugins/fontawesome-free/css/all.min.css">
  <!-- Ionicons -->
  <link rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
  <!-- Theme style -->
  <link rel="stylesheet" href="dist/css/adminlte.min.css">
  <!-- Google Font: Source Sans Pro -->
  <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700" rel="stylesheet">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <style>
    [class*=sidebar-dark-] {
      background-color: #143e89;
    }

    .card-warning:not(.card-outline)>.card-header {
      background-color: #ff0107;
      color: white;
    }

    .btn-primary {
      color: #fff;
      background-color: #ff0107;
      border-color: #ff0107;
      box-shadow: none;
    }

    .btn-secondary {

      background-color: #ff0107;
      border-color: #ff0107;
    }

    .logout {
      width: 100%;
    }
  </style>
</head>

<body class="hold-transition sidebar-mini layout-fixed">
  <div class="wrapper">
    <!-- Navbar -->
    <nav class="main-header navbar navbar-expand navbar-white navbar-light">
      <!-- Left navbar links -->
      <ul class="navbar-nav">
        <li class="nav-item">
          <a class="nav-link" data-widget="pushmenu" href="#" role="button"><i class="fas fa-bars"></i></a>
        </li>
        <!-- <li class="nav-item d-none d-sm-inline-block">
          <a href="index3.html" class="nav-link">Home</a>
        </li>
        <li class="nav-item d-none d-sm-inline-block">
          <a href="#" class="nav-link">Contact</a>
        </li> -->
      </ul>
      <!--
SEARCH FORM -->
      <div class="logout float-right l-3" style="width: 100%; text-align: right;">
        <button type="submit" class="btn btn-primary px-4 ml-2" onclick="logout()">
          <i"> <i class="fas fa-sign-out-alt" style="width: 40px; height:20px;"></i></i>
        </button>

      </div>
  </div>

  <!-- SEARCH FORM -->
  <!-- <form class="form-inline ml-3">
        <div class="input-group input-group-sm">
          <input class="form-control form-control-navbar" type="search" placeholder="Search" aria-label="Search">
          <div class="input-group-append">
            <button class="btn btn-navbar" type="submit">
              <i class="fas fa-search"></i>
            </button>
          </div>
        </div>
      </form> -->
  </nav>
  <!-- /.navbar -->

  <aside class="main-sidebar sidebar-dark-primary elevation-4">
    <div id="sideBarContent">

    </div>
  </aside>

  <!-- Content Wrapper. Contains page content -->
  <div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <section class="content-header">
      <div class="container-fluid">
        <div class="row mb-2">
          <div class="col-sm-6">
            <h1> Test Result</h1>
          </div>
          <div class="col-sm-6">
            <ol class="breadcrumb float-sm-right">
              <li class="breadcrumb-item"><a
                  href="/dashboard.html">Dashboard</a></li>
              <li class="breadcrumb-item active"> Test Result</li>
            </ol>
          </div>
        </div>
      </div><!-- /.container-fluid -->
    </section>

    <!-- Main content -->
    <section class="content">
      <input type="hidden" id="hiddenIDNewAppointmentTestResult">
      <div class="container-fluid">
        <div class="row">
          <!-- left column -->
          <div class="col-md-12">
            <!-- general form elements -->
            <div class="card card-warning">
              <div class="card-header">
                <h3 class="card-title" id="txtAddTestResult">Test Result</h3>
              </div>
              <!-- /.card-header -->
              <!-- form start -->
              <div role="form">
                <div class="card-body">
                  <div class="form-group">
                    <label for="ddlPatientName">Patient Name</label>
                    <select class="form-control select2" id="ddlPatientName" onchange="fillAppointmentList()"
                      style="width: 100%;">
                    <option value="">------ Select Patient Name ------</option>

                    </select>
                  </div>

                  <div class="form-group">
                    <label for="ddlAppointment">Appointment</label>
                    <select class="form-control select2" id="ddlAppointment" style="width: 100%;">
                      <option value="">------ Select Appointment Name ------</option>

                    </select>
                  </div>

                  <!-- <input id="file-input" type="file" multiple>
                  <div id="preview"></div> -->

                  <div class="form-group">
                    <label for="txtFileIinput">File input</label>
                    <div class="input-group">
                      <div class="custom-file">
                        <input type="file" class="custom-file-input" id="file-input" multiple>
                        <label class="custom-file-label" for="txtFileIinput">Choose file</label>
                      </div>
                      <div class="input-group-append">
                        <span class="input-group-text" id="">Upload</span>
                      </div>
                    </div>
                    <div id="preview" class="previewClass" style="position: relative; top: 20px; display: inline-flex;">
                        
                    </div>
                  </div>
                </div>
                <!-- /.card-body -->
                <div>
                  <button type="button" id="editButton" class="btn btn-primary px-5 ml-3 mb-4" onclick="SaveForm()">Add</button>
                  <button type="button" style="display: none;" id="cancelButton" class="btn btn-primary px-5 ml-3 mb-4" onclick="resetMasterAfterEdit()">Cancel</button>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- /.card -->

      </div><!-- /.container-fluid -->


      <div class="row">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Test Record</h3>

              <div class="card-tools">
                <div class="input-group input-group-sm" style="width: 150px;">
                  <input type="text" name="table_search" class="form-control float-right" placeholder="Search">

                  <div class="input-group-append">
                    <button type="button" class="btn btn-default"><i class="fas fa-search"></i></button>
                  </div>
                </div>
              </div>
            </div>
            <!-- /.card-header -->

            <div class="card-body table-responsive p-0">
              <table class="table table-hover text-nowrap">
                <thead style="text-align: center">
                  <tr>
                    <th class="tableColumnWidth">Patient Name</th>
                    <th class="tableColumnWidth">Appointment Date Time</th>
                    <!-- <th class="tableColumnWidth">Patient Test </th>
                    <th class="tableColumnWidth">File input </th> -->
                    <th class="tableColumnWidth" style="text-align: center;">Action</th>
                  </tr>
                </thead>
                <tbody id="TestResultTableBody" style="text-align: center;">

                </tbody>
              </table>
            </div>
            <!-- /.card-body -->
          </div>

          <!-- /.card -->
        </div>
      </div>
      <!-- /.content -->
  </div>


  <!-- /.content -->

  <!-- /.content-wrapper -->
  <footer class="main-footer">
    <div class="float-right d-none d-sm-block">

    </div>
    <strong>Copyright &copy; 2021<a href="https://nash.pk/">NASH</a>.</strong> All rights
    reserved.
  </footer>

  <!-- Control Sidebar -->
  <aside class="control-sidebar control-sidebar-dark">
    <!-- Control sidebar content goes here -->
  </aside>
  <!-- /.control-sidebar -->
  </div>
  <!-- ./wrapper -->

  <!-- jQuery -->
  <script src="plugins/jquery/jquery.min.js"></script>
  <!-- Bootstrap 4 -->
  <script src="plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
  <!-- bs-custom-file-input -->
  <script src="plugins/bs-custom-file-input/bs-custom-file-input.min.js"></script>
  <!-- AdminLTE App -->
  <script src="dist/js/adminlte.min.js"></script>
  <!-- AdminLTE for demo purposes -->
  <script src="dist/js/demo.js"></script>
  <script src="dist/js/pages/fixContent.js"></script>
  <script type="text/javascript">
    $(document).ready(function () {
      bsCustomFileInput.init();
      sideBar();

    });
  </script>
  <script type="text/javascript">
    $(document).ready(function () {
      fillPatientNameList();
      fillList();
    });

    var ta = [];
    var rowCounter = 0;
    var currentPage = 1;
    var rowSize = 100;
    var totalPages = 0;
    var companyIdForBranch;
    var rowDataAppointment = [];
    var tokenValue = localStorage.getItem("SessionKeyFromLogin");
    var id = 0;

    function fillPatientNameList() {
      $.ajax({
        url:  nashApi + '/api/Patient?Size=' + rowSize + "&page=" + currentPage,
        type: 'GET',
        dataType: 'json',
        headers: { 'token': tokenValue },
        success: function (data) {
          var value = data.data;
          fillPatientNameListContent(value);
        }
      });
    }

    function fillPatientNameListContent(valueList) {
      var ddlTest1 = document.getElementById('ddlPatientName');
      $.each(valueList, function (index, value) {
        var opt = document.createElement("option");
        var optEdit = document.createElement("option");
        opt.innerHTML = value.fullName;
        opt.setAttribute("PatientID", value.patientId);
        ddlTest1.append(opt);
      });
    }

    function fillAppointmentList() {
      var patientDropdown = document.getElementById('ddlPatientName');
      var patientID = patientDropdown.options[patientDropdown.selectedIndex].getAttribute('patientid');
      $.ajax({
        url: nashApi + '/api/Appointment/GetAppointmentByPatientId/ ' + patientID,
        type: 'GET',
        dataType: 'json',
        headers: { 'token': tokenValue },
        success: function (data) {
          var value = data;
          document.getElementById('ddlAppointment').innerHTML = "";
          fillAppointmentListContent(value);
        }
      });
    }

    function fillAppointmentListContent(valueList) {
      var ddlAppointment = document.getElementById('ddlAppointment');
      $.each(valueList, function (index, value) {
        var opt = document.createElement("option");
        var optEdit = document.createElement("option");
        opt.innerHTML = value.appointmentDateTime;
        opt.setAttribute("appointmentID", value.appointmentId);
        ddlAppointment.append(opt);
      });
    }

    function previewImages() {
      var preview = document.querySelector('#preview');
      if (this.files) {
        [].forEach.call(this.files, readAndPreview);
      }

      function readAndPreview(file) {
        // Make sure `file.name` matches our extensions criteria
        if (!/\.(jpe?g|png|gif)$/i.test(file.name)) {
          return alert(file.name + " is not an image");
        } // else...
        var reader = new FileReader();
        reader.addEventListener("load", function () {
          var newDiv = document.createElement('div');
          var buttonDel = document.createElement('button');
          buttonDel.textContent = 'Delete';
          buttonDel.classList.add("deleteButton");
          var buttonZoom = document.createElement('button');
          buttonZoom.textContent = 'Zoom';
          buttonZoom.classList.add("zoomButton");
          newDiv.classList.add("imageButtonDiv");
          var image = new Image();
          image.height = 200;
          image.title = file.name;
          image.src = this.result;
          debugger
          previewLength = preview.childElementCount;
          if(previewLength == 0){
            previewLength = "newImageID"+0;
          }
          else{
             previewLength = "newImageID"+previewLength ;
          }
          preview.appendChild(newDiv);
          newDiv.append(buttonDel);
          newDiv.append(buttonZoom);
          newDiv.append(image);
          newDiv.id = previewLength;
          $(".imageButtonDiv .deleteButton").click({param1: newDiv.id}, deleteImage);
          $(".imageButtonDiv .zoomButton").click({param1: image.src}, zoomImage);
        });
        reader.readAsDataURL(file);1
      }
    }
    document.querySelector('#file-input').addEventListener("change", previewImages);

    function fillList() {
      var URL = nashApi + '/api/AppointmentTestResult?Size=' + rowSize + "&page=" + currentPage;
      $.ajax({
        url: URL,
        type: 'GET',
        datatype: 'json',
        headers: { 'token': tokenValue },
        success: function (data) {
          var TestResultTableBody = document.getElementById('TestResultTableBody');
          if (data.pageCount == 0) {
            TestResultTableBody.innerHTML = '<td colspan="4">No Record Found</td>';
          }
          else {
            TestResultTableBody.innerHTML = '';
          }
          totalPages = data.pageCount;
          $.each(data.data, function (index, value) {
            var tableRow = document.createElement("tr");
            var tableCol = document.createElement("td");

            tableCol.innerHTML = value.appointment.patient.fullName;
            tableRow.appendChild(tableCol);

            tableCol = document.createElement("td");
            tableCol.innerHTML = value.appointment.appointmentDateTime;
            tableRow.appendChild(tableCol);

            var buttons = '<button type="button" style="margin-right:5px" class="btn btn-primary px-5 ml-3" onclick="editRow(' + value.appointmentTestResultId + ')"><i class="fa fa-edit"></i></button><button type="button" class="btn btn-secondary px-5" onclick="delRecord(' + value.appointmentTestResultId + ')"><i class="fa fa-trash "></i></button>';
            tableCol = document.createElement("td");
            tableCol.innerHTML = buttons;
            tableRow.appendChild(tableCol);
            TestResultTableBody.append(tableRow);
          });
          // document.getElementById("pagerText").innerHTML = "Page " + currentPage + " of " + totalPages;
        },
        error: function (request, message, error) {
          console.log(error);
        }
      });
    }

    function delRecord(recordId) {
      if (confirm('Are you sure you want to delete this record') == false) {
        return;
      }
      $.ajax({
        url: nashApi + '/api/AppointmentTestResult/Delete/' + recordId,
        type: 'POST',
        headers: { 'token': tokenValue },
        success: function (data) {
          fillList();
        },
        error: function (request, message, error) {
          console.log(error);
        }
      });
    }

    function SaveForm() {
        if (document.getElementById('TestResultTableBody').innerText != "")
        {
            if (document.getElementById('ddlPatientName').value != 0)
            {
                ListDetailsAppointmentImages();
                //var base64LoopImages = rowDataAppointment;
                var ddlAppointment = document.getElementById('ddlAppointment');
                var appointmentID = ddlAppointment.options[ddlAppointment.selectedIndex].getAttribute("appointmentID");
                var formData = {
                  appointmentTestResultId: 0,
                  appointmentId: appointmentID,
                  appointmentTestResultFileList: rowDataAppointment
                };
                debugger;
                if (id > 0) {
                    URL = nashApi + '/api/AppointmentTestResult/Put/' + id;
                }
                else {
                    URL = nashApi + '/api/AppointmentTestResult';
                }

                $.ajax({
                    url: URL,
                    type: 'POST',
                    dataType: 'json',
                    headers: { 'token': tokenValue },
                    data: formData,
                    success: function (data) {
                        var value = data.data;
                        alert('Record Saved Successfully');
                        fillList();
                        resetMaster();
                    },

                    error: function (request, message, error) {
                        fillList();
                        resetMaster();
                        console.log("error", error);
                    }
                });
            }
            else {
                alert("Please Fill All Form Values");
            }
        }
        else {
            alert("Please Add Some Items First");
        }
        }

        function ListDetailsAppointmentImages() {
          debugger;
            var previewDiv = document.getElementById("preview")
            var rowcounter = previewDiv.childElementCount;
            // var td = '[';
             //var td = '[';
            for (i = 0; i < rowcounter; i++) {
              console.log(previewDiv.childNodes[i]);
                var appointmentStringBase64 = previewDiv.childNodes[i].nextElementSibling.childNodes[2].currentSrc;
                rowDataAppointment.push(appointmentStringBase64);
            }
        }

      function editRow(recordId) {
      document.getElementById('txtAddTestResult').innerHTML = "Edit Test Result";
      document.getElementById('editButton').innerHTML = "Update";
      document.getElementById('cancelButton').style.display = "inline";
      id = recordId;
      setupForm(recordId);
    }

    function setupForm(recordId) {
        var recId = recordId;
        if (recId > 0) {
            getRecord(recId);
        }
    }

    function getRecord(recId) {
        $.ajax({
            url: nashApi + '/api/AppointmentTestResult/' + recId, //get
            type: 'GET',
            dataType: 'json',
            headers: { 'token': tokenValue },
            success: function (data) {
                value = data.data;
                document.getElementById('ddlPatientName').value = value.appointment.patient.fullName;
                fillAppointmentList();
                var imageListArrayLength = value.appointmentTestResultFileList.length;
                for(var a= 0 ; a < imageListArrayLength ; a++){
                  var image = new Image();
                  image.height = 200;
                  image.src = value.appointmentTestResultFileList[a];
                  preview.appendChild(image);
                }
                
            },
            error: function (request, message, error) {
                console.log(error);
            }
        });
    }

        function resetMaster(){
          document.getElementById('ddlPatientName').value = "";
          document.getElementById('ddlAppointment').innerHTML = '<option value="">------ Select Appointment Name ------</option>';
          document.getElementById('file-input').innerHTML = "";
          document.getElementById('preview').innerHTML = "";
        }

        function resetMasterAfterEdit(){
          id = 0;
          document.getElementById('txtAddTestResult').innerHTML = "Test Result";
          document.getElementById('cancelButton').style.display = "none";
          document.getElementById('editButton').innerHTML = "Add";
          document.getElementById('ddlPatientName').value = "";
          document.getElementById('ddlAppointment').innerHTML = '<option value="">------ Select Appointment Name ------</option>';
          document.getElementById('file-input').innerHTML = "";
          document.getElementById('preview').innerHTML = "";
        }
        
        function deleteImage(event){
          debugger;
          var imageButtonDiv = event.data.param1;
          document.getElementById(imageButtonDiv).remove();
        }

        function zoomImage(event){
          debugger;
          var imageButtonDiv = event.data.param1;
          var win = window.open();
          win.document.write('<iframe src="' + imageButtonDiv  + '" frameborder="0" style="border:0; top:0px; left:0px; bottom:0px; right:0px; width:100%; height:100%;" allowfullscreen></iframe>');
          //window.open(imageButtonDiv, '_blank')
        }

        
  </script>

</body>

</html>